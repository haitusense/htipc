<html lang="en">
<head>
  <meta charset="UTF-8">
</head>

<style type="text/css">
  canvas {
    image-rendering: pixelated;
  }
</style>

<body >
  <canvas id="canvas" width="320" height="240"
  ondrop="dropHandler(event);"
  ondragover="dragOverHandler(event);"
  ></canvas>
</body>

<script>
if(!window.chrome.webview) alert('webview not found');

// addEventListener DOMContentLoaded
window.addEventListener('DOMContentLoaded', () => window.chrome.webview.postMessage('DOMContentLoaded'));

window.addEventListener('load', () => {
  action('["load"]')
  action('["draw"]')

  document.getElementById("canvas").addEventListener('mousemove', async (event) => {
    // parseInt()はバグの温床
    // https://cpplover.blogspot.com/2009/06/dom-level-3.html
    const rect = event.target.getBoundingClientRect() ;
    const x = Math.trunc(event.clientX - rect.left);
    const y = Math.trunc(event.clientY - rect.top);
    action(`["mousemove", "${x}", "${y}"]`);
  });

  document.getElementById("canvas").addEventListener('mousewheel', async (event)=>{
    if (event.shiftKey) {
      event.preventDefault();
      if (event.wheelDelta > 0) { 
        action('["shiftup"]');
      } else { 
        action('["shiftdown"]');
      }
    } else if(event.ctrlKey) {
      // event.preventDefault();
      if (event.wheelDelta > 0) {
        action('["zoomup"]');
      } else {
        action('["zoomdown"]');
      }
      // stage.style.transform = `scale(${canvas_scale})`;
    } else {
      // console.log(`${event.wheelDelta}`)
    }

  }); 

  window.addEventListener('keydown', async (event) => {
    if(event.repeat == true) return;

    console.log(`${event.shiftKey ? "shift + " : ""}${event.ctrlKey ? "ctrl + " : ""}${event.altKey ? "alt + " : ""}${event.key}`);
  });

});

// addEventListener webview message
window.chrome.webview.addEventListener('message', (e) => {
  let json = e.data;
  switch(json.type){
    case "message":
      console.log(`from cs ${json.type} : ${json.payload}`.yellow());
      break;
    default:
      console.log(e);
  }
});

function dropHandler(ev) {
  console.log("File(s) dropped");

  // Prevent default behavior (Prevent file from being opened)
  ev.preventDefault();

  if (ev.dataTransfer.items) {
    // Use DataTransferItemList interface to access the file(s)
    [...ev.dataTransfer.items].forEach((item, i) => {
      // If dropped items aren't files, reject them
      if (item.kind === "file") {
        const file = item.getAsFile();
        console.log(`… file[${i}].name = ${file.name}`);
      }
    });
  } else {
    // Use DataTransfer interface to access the file(s)
    [...ev.dataTransfer.files].forEach((file, i) => {
      console.log(`… file[${i}].name = ${file.name}`);
    });
  }
}
function dragOverHandler(ev) {
  console.log("File(s) in drop zone");

  // Prevent default behavior (Prevent file from being opened)
  ev.preventDefault();
}
</script>

</html>