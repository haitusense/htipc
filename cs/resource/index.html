<html lang="en">
<head>
  <meta charset="UTF-8">
</head>

<style type="text/css">
  canvas {
    image-rendering: pixelated;
  }
</style>

<body>
  <canvas id="canvas" width="320" height="240" ></canvas>
</body>
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/rxjs/7.8.1/rxjs.umd.min.js"></script> -->
<script>
  if(!window.chrome.webview) alert('webview not found');
  /*asyncだと間に合わない*/
  window.addEventListener('DOMContentLoaded', () => console.log("DOMContentLoaded") );
  window.addEventListener('load', () => console.log("loading") );
</script>


<script type="module">
  console.log("module loading")
  const { fromEvent, range, filter, map, debounceTime, Observable } = window.rxjs;

  // addEventListener webview message / DOM Control
  console.log("Observe webview message")
  const wvMessage$ = fromEvent(window.chrome.webview, 'message');

  const propertyChanged$ = wvMessage$.pipe(filter(e => e.data.type === "propertyChanged"), map(e => e.data.data));
  propertyChanged$.pipe(filter(e => e.PropertyName === "Label")).subscribe(async (e) => {
    chrome.webview.hostObjects.statusLabel.Text = await chrome.webview.hostObjects.State.Label;
  });
  propertyChanged$.pipe(filter(e => e.PropertyName === "Shift")).subscribe(async (e) => {
    let val = await chrome.webview.hostObjects.State.Shift;
    await drawFromMemoryMap("canvas", val);
  });

  const pipeMessageReceived$ = wvMessage$.pipe(filter(e => e.data.type === "pipeMessageReceived"), map(e => e.data.data));
  pipeMessageReceived$.subscribe(async (e) => {
    console.log(e)
    dispatch(JSON.stringify(e));
  });

  console.log("Observe key / mouse event") 
  const mousemove$ = fromEvent(document.getElementById("canvas"), 'mousemove');
  mousemove$.pipe(debounceTime(100)).subscribe(async (event) => {
    // parseInt()はバグの温床
    // https://cpplover.blogspot.com/2009/06/dom-level-3.html
    const rect = event.target.getBoundingClientRect() ;
    const x = Math.trunc(event.clientX - rect.left);
    const y = Math.trunc(event.clientY - rect.top);
    dispatch(`{"type" : "mousemove", "payload": ["${x}", "${y}"] }`);
  });

  const mousewheel$ = fromEvent(document.getElementById("canvas"), 'mousewheel');
  mousewheel$.pipe(filter(e => e.shiftKey)).subscribe(async (event) => {
    event.preventDefault();
    if (event.wheelDelta > 0) {
      dispatch(`{ "type" : "shiftup", "payload" : ["1"] }`)
    } else {
      dispatch(`{ "type" : "shiftdown", "payload" : ["-1"] }`)
    }
    
  });
  mousewheel$.pipe(filter(e => e.ctrlKey)).subscribe(async (event) => {
    // event.preventDefault();
    if (event.wheelDelta > 0) {
      dispatch(`{ "type" : "zoomup", "payload": [] }`)
    } else {
      dispatch(`{ "type" : "zoomdown", "payload": [] }`)
    }
    // stage.style.transform = `scale(${canvas_scale})`;
  });

  const keyevent$ = fromEvent(window, 'keydown');
  keyevent$.pipe(filter(e => e.repeat =! true)).subscribe(async (event) => {
    console.log(`${event.shiftKey ? "shift + " : ""}${event.ctrlKey ? "ctrl + " : ""}${event.altKey ? "alt + " : ""}${event.key}`);
  });

  // let a = await setUserName("setUserName");
  // console.log(a);
  // これすると、loadingのあとになる

</script>

</html>